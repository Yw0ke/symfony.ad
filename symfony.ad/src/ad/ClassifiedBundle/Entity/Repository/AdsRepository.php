<?php

namespace ad\ClassifiedBundle\Entity\Repository;

use Doctrine\ORM\Query\Parameter;

use Doctrine\Common\Collections\ArrayCollection;

use Doctrine\ORM\EntityRepository;
use ad\ClassifiedBundle\Entity\attribute_values;


/**
 * AdsRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class AdsRepository extends EntityRepository
{
	/**
	 * Get ad's info.
	 *
	 * @return array(attributeValues)
	 */
	public function getFullInfoById($id)
	{
		$em = $this->getEntityManager();
		
		$qb = $em->createQueryBuilder();
		$qb->addSelect('v');
		$qb->addSelect('ads');
		$qb->addSelect('attr');
		$qb->from('adClassifiedBundle:attributeValues','v');
		$qb->leftJoin('v.AdsId', 'ads');
		$qb->leftJoin('v.attributeId', 'attr');
		$qb->where('v.AdsId = :id');

		$qb->setParameter('id', $id);
		
		return $response = $qb->getQuery()->getResult();
	}
	
	/**
	 * Get unconfirmed ads's minimum info for dashboardadmin.
	 *
	 * @return array(attributeValues)
	 */
	public function getUnconfirmedAds()
	{
		$em = $this->getEntityManager();
	
		$qb = $em->createQueryBuilder();
		$qb->addSelect('v');
		$qb->addSelect('ads');
		$qb->addSelect('attr');;
		$qb->from('adClassifiedBundle:attributeValues','v');
		$qb->leftJoin('v.AdsId', 'ads');
		$qb->leftJoin('v.attributeId', 'attr');
		$qb->where('attr.name = :price');
		$qb->orWhere('attr.name = :ownerType');
		$qb->orWhere('attr.name = :ownerCity');
		$qb->orWhere('attr.name =:Confirmed');
		$qb->orderBy('ads.id');
		
		$qb->setParameters(new ArrayCollection(array(
													 new Parameter(':price', 'Price'),
													 new Parameter(':ownerType', 'OwnerType'),
													 new Parameter(':ownerCity', 'OwnerCity'),
													 new Parameter(':Confirmed', 'Confirmed')
													 )));

		$response = $qb->getQuery()->getResult();
		
		$orga = array();
		
		foreach ($response as $attVal)
		{
			$value = $attVal->getValue();
			$attribute = $attVal->getAttributeId()->getName();
			
			$ad = $attVal->getAdsId();

			$ad->addAttribute($attribute, $value);
			
			$orga[$ad->getId()] = $ad;
			
			$att = $orga[$ad->getId()]->getAttribute();

			if (isset($att['Confirmed']) && $att['Confirmed'] != 0)	//Tri des entité non confirmer.
			{
				unset($orga[$ad->getId()]);
			}			
		}
		
		foreach ($orga as $ad)	//Boucle qui retire la paire Confirmed => Value, non souhaiter ici.
		{
			$att = $ad->getAttribute();
			unset($att['Confirmed']);
			$ad->setAttribute($att);
			
			$orga[$ad->getId()] = $ad;
		}
		
		return $orga;	//retour d'un tableau d'entité Ads avec Attribut => Valeur
	}
}
